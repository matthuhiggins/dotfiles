# Lists every node
#
# ec2 pipeline_web production
function ec2 {
  knife search node -a ec2.public_hostname "role:$1 AND chef_environment:$2"
}

# Runs a command on every server
#
# ec2ssh pipeline_web production "rake assets:precompile"
function ec2ssh {
  knife ssh "role:$1 AND chef_environment:$2" "$3"
}

# Starts a screen session on every server
#
# ec2screen pipeline_web production
function ec2screen {
  TERM=xterm ec2ssh $1 $2 screen
}

# Deploys chef
#
# ec2deploy pipeline_web production
function ec2deploy {
  ec2ssh $1 $2 "axle deploy"
  # knife ssh "role:$1 AND chef_environment:$2" "axle deploy"
}

# Logs into a random IP
#
# ec2deploy pipeline_web production
function ec2login {
  IP=$(knife search "role:$1 AND chef_environment:$2" | grep IP | head -1 | awk '{print $2}')
  ssh $IP
  # knife ssh "role:$1 AND chef_environment:$2" "axle deploy"
}

# ec2console pipeline_web production
function ec2console {
  IP=$(knife search "role:$1 AND chef_environment:$2" | grep IP | head -1 | awk '{print $2}')
  ssh -t $IP "source /etc/profile; axle console"
}

function ec2dump {
  IP=$(knife search "role:$1 AND chef_environment:$2" | grep IP|head -1|awk '{print $2}')
  ssh -t $IP "source /etc/profile; axle console"

  # ssh [ip]
  # sudo mysqldump --host=place-directory-production.cgvlc4fhupvi.us-east-1.rds.amazonaws.com --user=content_system_ --password=eemaizaemo9cahR  --ignore-table=content_system_.subscription_notifications --ignore-table=content_system_.delayed_jobs content_system_ | gzip > /tmp/dump.sql.gz
  #
  # scp [ip]:/tmp/dump.sql.gz dev_data/
  # gunzip < dev_data/dump.sql.gz | mysql -u root content_system_
}
